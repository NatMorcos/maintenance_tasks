#!/bin/sh

set -ex

gem_path="$PWD"
cd "${install_dir:=..}"
if [ -d "${app_name:=maintenance_tasks_example}" ]; then
	>&2 echo "Stopping: directory exists"
	exit 1
fi

# clean up
mkdir "$app_name"
cd "$app_name"
app_path="$PWD"
cd ..
trap 'rm -rf "$app_path"' EXIT

interactive=
if [ "$1" = "-i" ]; then
	interactive=1
	shift
fi

# install rails
rails new --skip-javascript --skip-spring --skip-git "$@" $app_name
cd "$app_name"

sed s/app://g "$gem_path"/bin/production > bin/production
if [ "$CLASSIC_AUTOLOADER" ]; then
	sed -i '' "/load_defaults/ a\\
		\\    config.autoloader = :classic
	" config/application.rb
fi

cat >app/controllers/home_controller.rb <<EOF
class HomeController < ApplicationController
  def index
    render plain: "home"
  end
end
EOF

sed -i '' "/^end/ i\\
	\\  root to: 'home#index'
" config/routes.rb

if [ $interactive ]; then
	echo
	echo '# Before install, feel free to tweak the Rails app'
	PS1="$ " sh -i
fi

# install gem
echo "gem 'maintenance_tasks', path: '$gem_path'" >> Gemfile
bundle
rails generate maintenance_tasks:install

cp "$gem_path"/test/dummy/app/tasks/maintenance/* app/tasks/maintenance

if [ $interactive ]; then
	echo "# Shell"
	PS1="$ " sh -i
else
	# run server
	set -m
	rails s &
	sleep 3
	open http://localhost:3000/maintenance_tasks
	fg
fi
